# Consul acceptance tests running against OpenShift cluster
name: OpenShift Acceptance Tests

on:
  push:
# schedule:
#     # Run on Monday (1),Wednesday (3),and Friday (5) at 6:00 AM UTC, 1:00 AM EST, 10:00 PM PST
#     - cron:  '0 6 * * 1,3,5'

jobs:
  openshift:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout Code
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
        with:
          version: 3.9.4

      - name: Install Podman
        run: |
          . /etc/os-release
          echo "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_22.04/ /" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
          curl -fsSL "https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_22.04/Release.key" | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/libcontainers.gpg
          sudo apt-get update
          sudo apt-get -y upgrade
          sudo apt-get -y install podman

      - name: Setup OpenShift Client and kubectl
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz | sudo tar -xz -C /usr/local/bin
          sudo chmod +x /usr/local/bin/oc /usr/local/bin/kubectl

      - name: Download and Install Microshift
        run: |
          # Download the latest Microshift binary
          curl -L -o microshift https://github.com/redhat-et/microshift/releases/latest/download/microshift-linux-amd64
          chmod +x microshift
          sudo mv microshift /usr/local/bin/microshift

          # Set up directories for Microshift
          sudo mkdir -p /etc/microshift /var/lib/microshift

          # Start MicroShift in the background
          sudo microshift run &

          # Wait for Microshift to become ready
          echo "Waiting for Microshift to be ready..."
          timeout=300  # 5 minutes
          start_time=$(date +%s)
          while true; do
            if sudo kubectl get --raw='/readyz' &> /dev/null; then
              echo "Microshift is ready!"
              break
            fi
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            if [ $elapsed -ge $timeout ]; then
              echo "Timeout reached. Microshift is not ready after 5 minutes."
              exit 1
            fi
            sleep 5
          done

      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          sudo cp /var/lib/microshift/resources/kubeadmin/kubeconfig ~/.kube/config
          sudo chown $(whoami):$(whoami) ~/.kube/config
          kubectl get nodes

      - name: Install Consul on Microshift
        run: |
          helm repo add hashicorp https://helm.releases.hashicorp.com
          helm repo update
          kubectl create namespace consul
          helm install consul hashicorp/consul --namespace consul --set global.name=consul
          kubectl rollout status statefulset/consul-server -n consul --timeout=300s
          kubectl get pods -n consul