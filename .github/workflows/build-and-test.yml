name: test-and-build 
on:
  push:
    tags:
      - v*
    branches:
      - crt-build-and-tests 
  pull_request:

jobs:
  validate-helm-gen:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"

  go-fmt-vet-helm-gen:
    uses: hashicorp/consul-k8s/.github/workflows/reusable-go-fmt-vet.yml@crt-build-and-tests
    with:
      directory: hack/helm-reference-gen
      go-version: 1.17.2

  unit-helm-gen:
    uses: hashicorp/consul-k8s/.github/workflows/reusable-unit.yml@crt-build-and-tests
    with:
      directory: hack/helm-reference-gen
      go-version: 1.17.2
    needs: [go-fmt-vet-helm-gen, validate-helm-gen]

  unit-test-helm-template:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [unit-helm-gen]

  lint-control-plane:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"

  go-fmt-vet-control-plane:
    uses: hashicorp/consul-k8s/.github/workflows/reusable-go-fmt-vet.yml@crt-build-and-tests
    with:
      directory: control-plane
      go-version: 1.17.2

  test-control-plane:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [lint-control-plane, go-fmt-vet-control-plane]

  test-enterprise-control-plane:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [lint-control-plane, go-fmt-vet-control-plane]

  build-distros-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [test-control-plane, test-enterprise-control-plane]

  build-distros-arm-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [test-control-plane, test-enterprise-control-plane]

  build-distros-386:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [test-control-plane, test-enterprise-control-plane]

  go-fmt-vet-acceptance:
    uses: hashicorp/consul-k8s/.github/workflows/reusable-go-fmt-vet.yml@crt-build-and-tests
    with:
      directory:  acceptance 
      go-version: 1.17.2

  unit-acceptance-framework:
    uses: hashicorp/consul-k8s/.github/workflows/reusable-unit.yml@crt-build-and-tests
    with:
      directory: accepance/framework
      go-version: 1.17.2
    needs: go-fmt-vet-acceptance

  go-fmt-vet-cli:
    uses: hashicorp/consul-k8s/.github/workflows/reusable-go-fmt-vet.yml@crt-build-and-tests
    with:
      directory: cli 
      go-version: 1.17.2

  unit-cli:
    uses: hashicorp/consul-k8s/.github/workflows/reusable-unit.yml@crt-build-and-tests
    with:
      directory: cli 
      go-version: 1.17.2
    needs: go-fmt-vet-cli

  dev-upload-docker:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: build-distros-amd64

  acceptance-tproxy:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [unit-cli, dev-upload-docker, unit-acceptance-framework, unit-test-helm-template]

  acceptance:
    runs-on: ubuntu-latest
    steps:
      - name: TODO
        run:
         echo "Filler"
    needs: [unit-cli, dev-upload-docker, unit-acceptance-framework, unit-test-helm-template]










